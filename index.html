<!DOCTYPE html><html lang="en" dir="ltr"><head>
<meta charset="utf-8">
<meta name="generator" content="ReSpec 26.16.0">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<style>
dfn{cursor:pointer}
.dfn-panel{position:absolute;z-index:35;min-width:300px;max-width:500px;padding:.5em .75em;margin-top:.6em;font:small Helvetica Neue,sans-serif,Droid Sans Fallback;background:#fff;color:#000;box-shadow:0 1em 3em -.4em rgba(0,0,0,.3),0 0 1px 1px rgba(0,0,0,.05);border-radius:2px}
.dfn-panel:not(.docked)>.caret{position:absolute;top:-9px}
.dfn-panel:not(.docked)>.caret::after,.dfn-panel:not(.docked)>.caret::before{content:"";position:absolute;border:10px solid transparent;border-top:0;border-bottom:10px solid #fff;top:0}
.dfn-panel:not(.docked)>.caret::before{border-bottom:9px solid #a2a9b1}
.dfn-panel *{margin:0}
.dfn-panel b{display:block;color:#000;margin-top:.25em}
.dfn-panel ul a[href]{color:#333}
.dfn-panel>div{display:flex}
.dfn-panel a.self-link{font-weight:700;margin-right:auto}
.dfn-panel .marker{padding:.1em;margin-left:.5em;border-radius:.2em;text-align:center;white-space:nowrap;font-size:90%;color:#040b1c}
.dfn-panel .marker.dfn-exported{background:#d1edfd;box-shadow:0 0 0 .125em #1ca5f940}
.dfn-panel .marker.idl-block{background:#8ccbf2;box-shadow:0 0 0 .125em #0670b161}
.dfn-panel a:not(:hover){text-decoration:none!important;border-bottom:none!important}
.dfn-panel a[href]:hover{border-bottom-width:1px}
.dfn-panel ul{padding:0}
.dfn-panel li{margin-left:1em}
.dfn-panel.docked{position:fixed;left:.5em;top:unset;bottom:2em;margin:0 auto;max-width:calc(100vw - .75em * 2 - .5em - .2em * 2);max-height:30vh;overflow:auto}
</style>
    
    
<title>Web Components Community Group: 2021 Spec/API status</title>
    
    
  
<style id="respec-mainstyle">
@keyframes pop{
0%{transform:scale(1,1)}
25%{transform:scale(1.25,1.25);opacity:.75}
100%{transform:scale(1,1)}
}
.hljs{background:0 0!important}
:is(h1,h2,h3,h4,h5,h6,a) abbr{border:none}
dfn{font-weight:700}
a.internalDFN{color:inherit;border-bottom:1px solid #99c;text-decoration:none}
a.externalDFN{color:inherit;border-bottom:1px dotted #ccc;text-decoration:none}
a.bibref{text-decoration:none}
.respec-offending-element:target{animation:pop .25s ease-in-out 0s 1}
.respec-offending-element,a[href].respec-offending-element{text-decoration:red wavy underline}
@supports not (text-decoration:red wavy underline){
.respec-offending-element:not(pre){display:inline-block}
.respec-offending-element{background:url(data:image/gif;base64,R0lGODdhBAADAPEAANv///8AAP///wAAACwAAAAABAADAEACBZQjmIAFADs=) bottom repeat-x}
}
#references :target{background:#eaf3ff;animation:pop .4s ease-in-out 0s 1}
cite .bibref{font-style:normal}
code{color:#c63501}
th code{color:inherit}
a[href].orcid{padding-left:4px;padding-right:4px}
a[href].orcid>svg{margin-bottom:-2px}
.toc a,.tof a{text-decoration:none}
a .figno,a .secno{color:#000}
ol.tof,ul.tof{list-style:none outside none}
.caption{margin-top:.5em;font-style:italic}
table.simple{border-spacing:0;border-collapse:collapse;border-bottom:3px solid #005a9c}
.simple th{background:#005a9c;color:#fff;padding:3px 5px;text-align:left}
.simple th a{color:#fff;padding:3px 5px;text-align:left}
.simple th[scope=row]{background:inherit;color:inherit;border-top:1px solid #ddd}
.simple td{padding:3px 10px;border-top:1px solid #ddd}
.simple tr:nth-child(even){background:#f0f6ff}
.section dd>p:first-child{margin-top:0}
.section dd>p:last-child{margin-bottom:0}
.section dd{margin-bottom:1em}
.section dl.attrs dd,.section dl.eldef dd{margin-bottom:0}
#issue-summary>ul{column-count:2}
#issue-summary li{list-style:none;display:inline-block}
details.respec-tests-details{margin-left:1em;display:inline-block;vertical-align:top}
details.respec-tests-details>*{padding-right:2em}
details.respec-tests-details[open]{z-index:999999;position:absolute;border:thin solid #cad3e2;border-radius:.3em;background-color:#fff;padding-bottom:.5em}
details.respec-tests-details[open]>summary{border-bottom:thin solid #cad3e2;padding-left:1em;margin-bottom:1em;line-height:2em}
details.respec-tests-details>ul{width:100%;margin-top:-.3em}
details.respec-tests-details>li{padding-left:1em}
a[href].self-link:hover{opacity:1;text-decoration:none;background-color:transparent}
h2,h3,h4,h5,h6{position:relative}
aside.example .marker>a.self-link{color:inherit}
:is(h2,h3,h4,h5,h6)>a.self-link{border:none;color:inherit;font-size:83%;height:2em;left:-1.6em;opacity:.5;position:absolute;text-align:center;text-decoration:none;top:0;transition:opacity .2s;width:2em}
:is(h2,h3,h4,h5,h6)>a.self-link::before{content:"§";display:block}
@media (max-width:767px){
dd{margin-left:0}
:is(h2,h3,h4,h5,h6)>a.self-link{left:auto;top:auto}
}
@media print{
.removeOnSave{display:none}
}
</style>
<style>
ul.index{columns:30ch;column-gap:1.5em}
ul.index li{list-style:inherit}
ul.index li span{color:inherit;cursor:pointer;white-space:normal}
#index-defined-here ul.index li{font-size:.9rem}
ul.index code{color:inherit}
#index-defined-here .print-only{display:none}
@media print{
#index-defined-here .print-only{display:initial}
}
</style>
<meta name="description" content="This is required.">
<style>
var{position:relative;cursor:pointer}
var[data-type]::after,var[data-type]::before{position:absolute;left:50%;top:-6px;opacity:0;transition:opacity .4s;pointer-events:none}
var[data-type]::before{content:"";transform:translateX(-50%);border-width:4px 6px 0 6px;border-style:solid;border-color:transparent;border-top-color:#000}
var[data-type]::after{content:attr(data-type);transform:translateX(-50%) translateY(-100%);background:#000;text-align:center;font-family:"Dank Mono","Fira Code",monospace;font-style:normal;padding:6px;border-radius:3px;color:#daca88;text-indent:0;font-weight:400}
var[data-type]:hover::after,var[data-type]:hover::before{opacity:1}
</style>
<script id="initialUserConfig" type="application/json">{
  "specStatus": "CG-DRAFT",
  "latestVersion": null,
  "edDraftURI": null,
  "editors": [
    {
      "name": "Westbrook Johnson",
      "url": "https://westbrookjohnson.com"
    },
    {
      "name": "Alan Dávalos",
      "url": "https://github.com/alangdm"
    },
    {
      "name": "William Riley",
      "url": "https://github.com/splitinfinities"
    },
    {
      "name": "Justin Fagnani",
      "url": "https://github.com/justinfagnani"
    }
  ],
  "github": "w3c/webcomponents-cg",
  "shortName": "webcomponents-cg",
  "xref": "web-platform",
  "group": "webcomponents",
  "tocIntroductory": true,
  "publishISODate": "2021-10-15T00:00:00.000Z",
  "generatedSubtitle": "Draft Community Group Report 15 October 2021"
}</script>
<link rel="stylesheet" href="https://www.w3.org/StyleSheets/TR/2016/cg-draft"></head>
  <body class="h-entry" data-cite="HTML INFRA URL WEBIDL DOM FETCH"><div class="head">
     <h1 id="title" class="title">Web Components Community Group: 2021 Spec/API status</h1>
    
    <h2>
      Draft Community Group Report
      <time class="dt-published" datetime="2021-10-15">15 October 2021</time>
    </h2>
    <dl>
      
      
      
      
      
      
      
      <dt>Editors:</dt>
      <dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://westbrookjohnson.com">Westbrook Johnson</a>
  </dd><dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://github.com/alangdm">Alan Dávalos</a>
  </dd><dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://github.com/splitinfinities">William Riley</a>
  </dd><dd class="editor p-author h-card vcard">
    <a class="u-url url p-name fn" href="https://github.com/justinfagnani">Justin Fagnani</a>
  </dd>
      
      
      
    </dl>
    
    <p class="copyright">
          <a href="https://www.w3.org/Consortium/Legal/ipr-notice#Copyright">Copyright</a>
          ©
          2021
          
          the Contributors to the Web Components Community Group: 2021 Spec/API status
          Specification, published by the
          <a href="https://www.w3.org/community/webcomponents/">Web Components Community Group</a> under the
          <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>. A human-readable
                <a href="https://www.w3.org/community/about/agreements/cla-deed/">summary</a>
                is available.
              
        </p>
    <hr title="Separator for header">
  </div>
    <section id="abstract" class="introductory"><h2>Abstract</h2>
      <p>This is required.</p>
    </section>
    <section id="sotd" class="introductory"><h2>Status of This Document</h2><p>
      This specification was published by the
      <a href="https://www.w3.org/community/webcomponents/">Web Components Community Group</a>. It is not a W3C Standard nor is it
      on the W3C Standards Track.
      
            Please note that under the
            <a href="https://www.w3.org/community/about/agreements/cla/">W3C Community Contributor License Agreement (CLA)</a>
            there is a limited opt-out and other conditions apply.
          
      Learn more about
      <a href="https://www.w3.org/community/">W3C Community and Business Groups</a>.
    </p>
      <p>This is required.</p>
    <p>
    <a href="https://github.com/w3c/webcomponents-cg/issues/">GitHub Issues</a> are preferred for
          discussion of this specification.
        
    
  </p></section><nav id="toc"><h2 class="introductory" id="table-of-contents">Table of Contents</h2><ol class="toc"><li class="tocline"><a class="tocxref" href="#abstract">Abstract</a></li><li class="tocline"><a class="tocxref" href="#sotd">Status of This Document</a></li><li class="tocline"><a class="tocxref" href="#introduction"><bdi class="secno">1. </bdi>Introduction</a></li><li class="tocline"><a class="tocxref" href="#form-associated-custom-elements"><bdi class="secno">2. </bdi>Form-Associated Custom Elements</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#description"><bdi class="secno">2.1 </bdi>Description</a></li><li class="tocline"><a class="tocxref" href="#motivation"><bdi class="secno">2.2 </bdi>Motivation</a></li></ol></li><li class="tocline"><a class="tocxref" href="#cross-root-aria"><bdi class="secno">3. </bdi>Cross-root ARIA</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#description-0"><bdi class="secno">3.1 </bdi>Description</a></li><li class="tocline"><a class="tocxref" href="#motivation-0"><bdi class="secno">3.2 </bdi>Motivation</a></li></ol></li><li class="tocline"><a class="tocxref" href="#constructable-stylesheets-adoptedstylesheets"><bdi class="secno">4. </bdi>Constructable Stylesheets &amp; adoptedStyleSheets</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#description-1"><bdi class="secno">4.1 </bdi>Description</a></li><li class="tocline"><a class="tocxref" href="#motivation-1"><bdi class="secno">4.2 </bdi>Motivation</a></li></ol></li><li class="tocline"><a class="tocxref" href="#feature-or-problem"><bdi class="secno">5. </bdi>Feature or Problem</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#description-2"><bdi class="secno">5.1 </bdi>Description</a></li><li class="tocline"><a class="tocxref" href="#motivation-2"><bdi class="secno">5.2 </bdi>Motivation</a></li></ol></li><li class="tocline"><a class="tocxref" href="#conformance"><bdi class="secno">6. </bdi>Conformance</a></li><li class="tocline"><a class="tocxref" href="#index"><bdi class="secno">A. </bdi>Index</a><ol class="toc"><li class="tocline"><a class="tocxref" href="#index-defined-here"><bdi class="secno">A.1 </bdi>Terms defined by this specification</a></li><li class="tocline"><a class="tocxref" href="#index-defined-elsewhere"><bdi class="secno">A.2 </bdi>Terms defined by reference</a></li></ol></li></ol></nav>
    <section class="informative" id="introduction">
      <h2 id="x1-introduction"><bdi class="secno">1. </bdi>Introduction<a class="self-link" aria-label="§" href="#introduction"></a></h2><p><em>This section is non-normative.</em></p>
      <p>Some informative introductory text.</p>
      <table>
        <thead>
          <tr>
            <th>Feature or Problem</th>
            <th>GitHub Issue(s)</th>
            <th>Priority</th>
            <th>Status(?)</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th><a href="#form-associated-custom-elements">Form-Associated Custom Elements</a></th>
            <td><a href="https://github.com/WICG/webcomponents/issues/187">WICG/webcomponents#187</a></td>
            <td>Critical</td>
            <td>Some implementation</td>
          </tr>
          <tr>
            <th><a href="#cross-root-aria">Cross-root ARIA</a></th>
            <td>
              <a href="https://github.com/WICG/aom/issues/169">WICG/aom#169</a><br>
              <a href="https://github.com/WICG/aom/issues/107">WICG/aom#107</a><br>
              <a href="https://github.com/WICG/webcomponents/issues/917">WICG/webcomponents#917</a><br>
              <a href="https://github.com/WICG/webcomponents/issues/916">WICG/webcomponents#916</a>
            </td>
            <td>Critial</td>
            <td>Uncertian</td>
          </tr>
          <tr>
            <th><a href="http://localhost:8080/status.html#constructable-stylesheets-adoptedstylesheets">Constructable Stylesheets &amp; adoptedStyleSheets</a></th>
            <td><a href="https://github.com/WICG/webcomponents/issues/169">WICG/webcomponents#468</a></td>
            <td>Critical</td>
            <td>Some implementation</td>
          </tr>
          <tr>
            <th>---</th>
            <td>---</td>
            <td>---</td>
            <td>---</td>
          </tr>
        </tbody>
      </table>
    </section>
     <section id="form-associated-custom-elements">
      <h2 id="x2-form-associated-custom-elements"><bdi class="secno">2. </bdi>Form-Associated Custom Elements<a class="self-link" aria-label="§" href="#form-associated-custom-elements"></a></h2>
      <dl>
        <dt>GitHub Issue(s):</dt>
        <dd><a href="https://github.com/WICG/webcomponents/issues/187">WICG/webcomponents#187</a></dd>
        <dt>Priority:</dt>
        <dd>Critical</dd>
        <dt>Status:</dt>
        <dd>Some implementation</dd>
      </dl>
      <section id="description">
        <h3 id="x2-1-description"><bdi class="secno">2.1 </bdi>Description<a class="self-link" aria-label="§" href="#description"></a></h3>
        <p>Form-associated custom elements allow custom elements to participate in forms to the same degree as native elements, including integrations with the form’s validation, state, and submission as well as exposing the Accessibility Object Model to the element.</p>
        <p>A sample use case can be found in <a href="https://css-tricks.com/creating-custom-form-controls-with-elementinternals/">this article by Caleb Williams</a>.</p>
      </section>
      <section id="motivation">
        <h3 id="x2-2-motivation"><bdi class="secno">2.2 </bdi>Motivation<a class="self-link" aria-label="§" href="#motivation"></a></h3>
        <p>One of the most common use cases for web components is creating form controls not available natively. Some examples include switches and credit card inputs.</p>
        <p>There is no way for forms to fully integrate with form elements located in a different shadow root the same way they would with form elements in the same root. The only options available to achieve a similar result are:</p>
        <ul>
          <li>The formdata event: this event only provides integration on form submission. Using this feature alone may also lead to accessibility issues due to the lack of cross-root ARIA.</li>
          <li>
            Setting a form element in light DOM (e.g. using slots): this gives web components authors two main options both of which will only work with standard form elements, mostly for form submission, and require both implementers and end users to write more code:
            <ul>
              <li>Visually hide the form element in light DOM and synchronize its value to a visible form element located inside the web component’s shadow root.</li>
              <li>Have both the form element and its label located in slots and forgo the granular control shadow DOM gives you over how to allow for CSS customization.</li>
            </ul>
          </li>
        </ul>
        <p>This situation has forced developers to either not use web components for form elements or create their own form systems that allow for full integration (e.g. many big web component libraries such as Lion or Shoelace provide form systems that integrate with their components). This limits the reach web components could have as plug-in form elements for projects created with different tech stacks.</p>
      </section>
    </section>
    <section id="cross-root-aria">
      <h2 id="x3-cross-root-aria"><bdi class="secno">3. </bdi>Cross-root ARIA<a class="self-link" aria-label="§" href="#cross-root-aria"></a></h2>
      <dl>
        <dt>GitHub Issue(s):</dt>
        <dd><a href="https://github.com/WICG/aom/issues/169">WICG/aom#169</a></dd>
        <dd><a href="https://github.com/WICG/aom/issues/107">WICG/aom#107</a></dd>
        <dd><a href="https://github.com/WICG/webcomponents/issues/917">WICG/webcomponents#917</a></dd>
        <dd><a href="https://github.com/WICG/webcomponents/issues/916">WICG/webcomponents#916</a></dd>
        <dt>Priority:</dt>
        <dd>Critial</dd>
        <dt>Status:</dt>
        <dd>Uncertian</dd>
      </dl>
      <section id="description-0">
        <h3 id="x3-1-description"><bdi class="secno">3.1 </bdi>Description<a class="self-link" aria-label="§" href="#description-0"></a></h3>
        <ol>
          <li>Shadow root encapsulation currently prevents references between elements in different roots. Croot-root ARIA references would re-enable this platform feature within shadow roots.</li>
          <li>It's not possible to "forward" ARIA attributes from a custom element host into elements in the host's shadow root. For instance, a custom input that wants to allow users to customize the ARIA role, has no way to forward the role attribute to the encapsulated native input.</li>
        </ol>
      </section>
      <section id="motivation-0">
        <h3 id="x3-2-motivation"><bdi class="secno">3.2 </bdi>Motivation<a class="self-link" aria-label="§" href="#motivation-0"></a></h3>
        <p>It's critically important that content on the web be accessible. Making web component content accessible currently requires many complicated and only partially-successful work-arounds, such as:</p>
        <ul>
          <li>Observing and moving ARIA-related attributes across elements (for role, etc.)</li>
          <li>Using non-standard attributes for ARIA features, in order to apply them to elements in a shadow root.</li>
          <li>Requiring that custom elements users wrap/slot elements so that ARIA attributes can be placed directly on them. This gets very complicated as the number of slotted inputs and levels of shadow root nesting increase.</li>
          <li>Duplicating nodes across shadow root boundaries</li>
          <li>Abandoning Shadow DOM</li>
        </ul>
      </section>
    </section>
    <section id="constructable-stylesheets-adoptedstylesheets">
      <h2 id="x4-constructable-stylesheets-adoptedstylesheets"><bdi class="secno">4. </bdi>Constructable Stylesheets &amp; adoptedStyleSheets<a class="self-link" aria-label="§" href="#constructable-stylesheets-adoptedstylesheets"></a></h2>
      <dl>
        <dt>GitHub Issue(s):</dt>
        <dd><a href="https://github.com/WICG/webcomponents/issues/468">WICG/webcomponents#468</a></dd>
        <dt>Priority:</dt>
        <dd>Critical</dd>
        <dt>Status:</dt>
        <dd>Some implementation</dd>
      </dl>
      <section id="description-1">
        <h3 id="x4-1-description"><bdi class="secno">4.1 </bdi>Description<a class="self-link" aria-label="§" href="#description-1"></a></h3>
        <p>Constructable Stylesheets and <code>adoptedStyleSheets</code> enable adding styles directly to shadow roots without creating new DOM elements. Because a single stylesheet object can be adopted by multiple scopes, it also allows sharing of styles that can be centrally modified.</p>
      </section>
      <section id="motivation-1">
        <h3 id="x4-2-motivation"><bdi class="secno">4.2 </bdi>Motivation<a class="self-link" aria-label="§" href="#motivation-1"></a></h3>
        <ul>
          <li>There is no effective way to share styles across components while allowing them to be centrally modified.</li>
          <li>Creating <code>&lt;style&gt;</code> elements for each style used in each shadow root has a measurable performance overhead.</li>
          <li>CSS Module Scripts, another critical feature, depends on constructible stylesheets.</li>
        </ul>
      </section>
    </section>
    <section id="feature-or-problem">
      <h2 id="x5-feature-or-problem"><bdi class="secno">5. </bdi>Feature or Problem<a class="self-link" aria-label="§" href="#feature-or-problem"></a></h2>
      <dl>
        <dt>GitHub Issue(s):</dt>
        <dd>---</dd>
        <dt>Priority:</dt>
        <dd>---</dd>
        <dt>Status:</dt>
        <dd>---</dd>
      </dl>
      <section id="description-2">
        <h3 id="x5-1-description"><bdi class="secno">5.1 </bdi>Description<a class="self-link" aria-label="§" href="#description-2"></a></h3>
        <p>---</p>
      </section>
      <section id="motivation-2">
        <h3 id="x5-2-motivation"><bdi class="secno">5.2 </bdi>Motivation<a class="self-link" aria-label="§" href="#motivation-2"></a></h3>
        <p>---</p>
      </section>
    </section>
    <section id="conformance"><h2 id="x6-conformance"><bdi class="secno">6. </bdi>Conformance<a class="self-link" aria-label="§" href="#conformance"></a></h2><p>As well as sections marked as non-normative, all authoring guidelines, diagrams, examples, and notes in this specification are non-normative. Everything else in this specification is normative.</p>
      <p>
        This is required for specifications that contain normative material.
      </p>
    </section>
    <section id="index" class="appendix"><h2 id="a-index"><bdi class="secno">A. </bdi>Index<a class="self-link" aria-label="§" href="#index"></a></h2><section id="index-defined-here">
    <h3 id="a-1-terms-defined-by-this-specification"><bdi class="secno">A.1 </bdi>Terms defined by this specification<a class="self-link" aria-label="§" href="#index-defined-here"></a></h3>
    <ul class="index">
    
  </ul>
  </section><section id="index-defined-elsewhere">
    <h3 id="a-2-terms-defined-by-reference"><bdi class="secno">A.2 </bdi>Terms defined by reference<a class="self-link" aria-label="§" href="#index-defined-elsewhere"></a></h3>
    <ul class="index">
    
  </ul>
  </section></section>
  

<p role="navigation" id="back-to-top">
    <a href="#title"><abbr title="Back to Top">↑</abbr></a>
  </p><script id="respec-dfn-panel">(() => {
// @ts-check
if (document.respec) {
  document.respec.ready.then(setupPanel);
} else {
  setupPanel();
}

function setupPanel() {
  const listener = panelListener();
  document.body.addEventListener("keydown", listener);
  document.body.addEventListener("click", listener);
}

function panelListener() {
  /** @type {HTMLElement} */
  let panel = null;
  return event => {
    const { target, type } = event;

    if (!(target instanceof HTMLElement)) return;

    // For keys, we only care about Enter key to activate the panel
    // otherwise it's activated via a click.
    if (type === "keydown" && event.key !== "Enter") return;

    const action = deriveAction(event);

    switch (action) {
      case "show": {
        hidePanel(panel);
        /** @type {HTMLElement} */
        const dfn = target.closest("dfn, .index-term");
        panel = document.getElementById(`dfn-panel-for-${dfn.id}`);
        const coords = deriveCoordinates(event);
        displayPanel(dfn, panel, coords);
        break;
      }
      case "dock": {
        panel.style.left = null;
        panel.style.top = null;
        panel.classList.add("docked");
        break;
      }
      case "hide": {
        hidePanel(panel);
        panel = null;
        break;
      }
    }
  };
}

/**
 * @param {MouseEvent|KeyboardEvent} event
 */
function deriveCoordinates(event) {
  const target = /** @type HTMLElement */ (event.target);

  // We prevent synthetic AT clicks from putting
  // the dialog in a weird place. The AT events sometimes
  // lack coordinates, so they have clientX/Y = 0
  const rect = target.getBoundingClientRect();
  if (
    event instanceof MouseEvent &&
    event.clientX >= rect.left &&
    event.clientY >= rect.top
  ) {
    // The event probably happened inside the bounding rect...
    return { x: event.clientX, y: event.clientY };
  }

  // Offset to the middle of the element
  const x = rect.x + rect.width / 2;
  // Placed at the bottom of the element
  const y = rect.y + rect.height;
  return { x, y };
}

/**
 * @param {Event} event
 */
function deriveAction(event) {
  const target = /** @type {HTMLElement} */ (event.target);
  const hitALink = !!target.closest("a");
  if (target.closest("dfn:not([data-cite]), .index-term")) {
    return hitALink ? "none" : "show";
  }
  if (target.closest(".dfn-panel")) {
    if (hitALink) {
      return target.classList.contains("self-link") ? "hide" : "dock";
    }
    const panel = target.closest(".dfn-panel");
    return panel.classList.contains("docked") ? "hide" : "none";
  }
  if (document.querySelector(".dfn-panel:not([hidden])")) {
    return "hide";
  }
  return "none";
}

/**
 * @param {HTMLElement} dfn
 * @param {HTMLElement} panel
 * @param {{ x: number, y: number }} clickPosition
 */
function displayPanel(dfn, panel, { x, y }) {
  panel.hidden = false;
  // distance (px) between edge of panel and the pointing triangle (caret)
  const MARGIN = 20;

  const dfnRects = dfn.getClientRects();
  // Find the `top` offset when the `dfn` can be spread across multiple lines
  let closestTop = 0;
  let minDiff = Infinity;
  for (const rect of dfnRects) {
    const { top, bottom } = rect;
    const diffFromClickY = Math.abs((top + bottom) / 2 - y);
    if (diffFromClickY < minDiff) {
      minDiff = diffFromClickY;
      closestTop = top;
    }
  }

  const top = window.scrollY + closestTop + dfnRects[0].height;
  const left = x - MARGIN;
  panel.style.left = `${left}px`;
  panel.style.top = `${top}px`;

  // Find if the panel is flowing out of the window
  const panelRect = panel.getBoundingClientRect();
  const SCREEN_WIDTH = Math.min(window.innerWidth, window.screen.width);
  if (panelRect.right > SCREEN_WIDTH) {
    const newLeft = Math.max(MARGIN, x + MARGIN - panelRect.width);
    const newCaretOffset = left - newLeft;
    panel.style.left = `${newLeft}px`;
    /** @type {HTMLElement} */
    const caret = panel.querySelector(".caret");
    caret.style.left = `${newCaretOffset}px`;
  }

  // As it's a dialog, we trap focus.
  // TODO: when <dialog> becomes a implemented, we should really
  // use that.
  trapFocus(panel, dfn);
}

/**
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function trapFocus(panel, dfn) {
  /** @type NodeListOf<HTMLAnchorElement> elements */
  const anchors = panel.querySelectorAll("a[href]");
  // No need to trap focus
  if (!anchors.length) return;

  // Move focus to first anchor element
  const first = anchors.item(0);
  first.focus();

  const trapListener = createTrapListener(anchors, panel, dfn);
  panel.addEventListener("keydown", trapListener);

  // Hiding the panel releases the trap
  const mo = new MutationObserver(records => {
    const [record] = records;
    const target = /** @type HTMLElement */ (record.target);
    if (target.hidden) {
      panel.removeEventListener("keydown", trapListener);
      mo.disconnect();
    }
  });
  mo.observe(panel, { attributes: true, attributeFilter: ["hidden"] });
}

/**
 *
 * @param {NodeListOf<HTMLAnchorElement>} anchors
 * @param {HTMLElement} panel
 * @param {HTMLElement} dfn
 * @returns
 */
function createTrapListener(anchors, panel, dfn) {
  const lastIndex = anchors.length - 1;
  let currentIndex = 0;
  return event => {
    switch (event.key) {
      // Hitting "Tab" traps us in a nice loop around elements.
      case "Tab": {
        event.preventDefault();
        currentIndex += event.shiftKey ? -1 : +1;
        if (currentIndex < 0) {
          currentIndex = lastIndex;
        } else if (currentIndex > lastIndex) {
          currentIndex = 0;
        }
        anchors.item(currentIndex).focus();
        break;
      }

      // Hitting "Enter" on an anchor releases the trap.
      case "Enter":
        hidePanel(panel);
        break;

      // Hitting "Escape" returns focus to dfn.
      case "Escape":
        hidePanel(panel);
        dfn.focus();
        return;
    }
  };
}

/** @param {HTMLElement} panel */
function hidePanel(panel) {
  if (!panel) return;
  panel.hidden = true;
  panel.classList.remove("docked");
}
})()</script><script src="https://www.w3.org/scripts/TR/2016/fixup.js"></script></body></html>